<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <title>Apache Arrow Homepage</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Jekyll v3.8.4">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic,900">

    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/syntax.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-107500873-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-107500873-1');
</script>

    
  </head>


<body class="wrap">
  <header>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
  <a class="navbar-brand" href="/"><img src="/img/arrow-inverse-300px.png" height="60px"/></a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#arrow-navbar" aria-controls="arrow-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="arrow-navbar">
      <ul class="nav navbar-nav">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#"
             id="navbarDropdownProjectLinks" role="button" data-toggle="dropdown"
             aria-haspopup="true" aria-expanded="false">
             Project Links
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownProjectLinks">
            <a class="dropdown-item" href="/install/">Installation</a>
            <a class="dropdown-item" href="/release/">Releases</a>
            <a class="dropdown-item" href="/faq/">FAQ</a>
            <a class="dropdown-item" href="/blog/">Blog</a>
            <a class="dropdown-item" href="https://github.com/apache/arrow">Source Code</a>
            <a class="dropdown-item" href="https://issues.apache.org/jira/browse/ARROW">Issue Tracker</a>
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#"
             id="navbarDropdownCommunity" role="button" data-toggle="dropdown"
             aria-haspopup="true" aria-expanded="false">
             Community
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownCommunity">
            <a class="dropdown-item" href="http://mail-archives.apache.org/mod_mbox/arrow-user/">User Mailing List</a>
            <a class="dropdown-item" href="http://mail-archives.apache.org/mod_mbox/arrow-dev/">Dev Mailing List</a>
            <a class="dropdown-item" href="https://cwiki.apache.org/confluence/display/ARROW">Developer Wiki</a>
            <a class="dropdown-item" href="/committers/">Committers</a>
            <a class="dropdown-item" href="/powered_by/">Powered By</a>
          </div>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/docs/format/README.html"
             role="button" aria-haspopup="true" aria-expanded="false">
             Specification
          </a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#"
             id="navbarDropdownDocumentation" role="button" data-toggle="dropdown"
             aria-haspopup="true" aria-expanded="false">
             Documentation
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownDocumentation">
            <a class="dropdown-item" href="/docs">Project Docs</a>
            <a class="dropdown-item" href="/docs/python">Python</a>
            <a class="dropdown-item" href="/docs/cpp">C++</a>
            <a class="dropdown-item" href="/docs/java">Java</a>
            <a class="dropdown-item" href="/docs/c_glib">C GLib</a>
            <a class="dropdown-item" href="/docs/js">JavaScript</a>
            <a class="dropdown-item" href="/docs/r">R</a>
          </div>
        </li>
        <!-- <li><a href="/blog">Blog</a></li> -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#"
             id="navbarDropdownASF" role="button" data-toggle="dropdown"
             aria-haspopup="true" aria-expanded="false">
             ASF Links
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownASF">
            <a class="dropdown-item" href="http://www.apache.org/">ASF Website</a>
            <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a>
            <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Donate</a>
            <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a>
            <a class="dropdown-item" href="http://www.apache.org/security/">Security</a>
          </div>
        </li>
      </ul>
      <div class="flex-row justify-content-end ml-md-auto">
        <a class="d-sm-none d-md-inline pr-2" href="https://www.apache.org/events/current-event.html">
          <img src="https://www.apache.org/events/current-event-234x60.png"/>
        </a>
        <a href="http://www.apache.org/">
          <img src="/img/asf_logo.svg" width="120px"/>
        </a>
      </div>
      </div><!-- /.navbar-collapse -->
    </div>
  </nav>

  </header>

  <div class="container p-lg-4">
    <main role="main">
    
    
    
<h1>
  Speeding up R and Apache Spark using Apache Arrow
  <a href="/blog/2019/01/25/r-spark-improvements/" class="permalink" title="Permalink">âˆž</a>
</h1>



<p>
  <span class="badge badge-secondary">Published</span>
  <span class="published">
    25 Jan 2019
  </span>
  <br />
  <span class="badge badge-secondary">By</span>
  
    Javier Luraschi
  
</p>


    <!--

-->

<p><em><a href="https://github.com/javierluraschi">Javier Luraschi</a> is a software engineer at <a href="https://rstudio.com">RStudio</a></em></p>

<p>Support for Apache Arrow in Apache Spark with R is currently under active
development in the <a href="https://github.com/rstudio/sparklyr">sparklyr</a> and <a href="https://spark.apache.org/docs/latest/sparkr.html">SparkR</a> projects. This post explores early, yet
promising, performance improvements achieved when using R with <a href="https://spark.apache.org">Apache Spark</a>,
Arrow and <code class="highlighter-rouge">sparklyr</code>.</p>

<h1 id="setup">Setup</h1>

<p>Since this work is under active development, install <code class="highlighter-rouge">sparklyr</code> and
<code class="highlighter-rouge">arrow</code> from GitHub as follows:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">devtools</span><span class="o">::</span><span class="n">install_github</span><span class="p">(</span><span class="s2">"apache/arrow"</span><span class="p">,</span><span class="w"> </span><span class="n">subdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"r"</span><span class="p">,</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"apache-arrow-0.12.0"</span><span class="p">)</span><span class="w">
</span><span class="n">devtools</span><span class="o">::</span><span class="n">install_github</span><span class="p">(</span><span class="s2">"rstudio/sparklyr"</span><span class="p">,</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"apache-arrow-0.12.0"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>In this benchmark, we will use <a href="https://dplyr.tidyverse.org">dplyr</a>, but similar improvements can
be  expected from using <a href="https://cran.r-project.org/package=DBI">DBI</a>, or <a href="https://spark.rstudio.com/reference/#section-spark-dataframes">Spark DataFrames</a> in <code class="highlighter-rouge">sparklyr</code>.
The local Spark connection and dataframe with 10M numeric rows was
initialized as follows:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">sparklyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">

</span><span class="n">sc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">spark_connect</span><span class="p">(</span><span class="n">master</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="s2">"sparklyr.shell.driver-memory"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"6g"</span><span class="p">))</span><span class="w">
</span><span class="n">data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runif</span><span class="p">(</span><span class="m">10</span><span class="o">^</span><span class="m">7</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<h1 id="copying">Copying</h1>

<p>Currently, copying data to Spark using <code class="highlighter-rouge">sparklyr</code> is performed by persisting
data on-disk from R and reading it back from Spark. This was meant to be used
for small datasets since there are better tools to transfer data into
distributed storage systems. Nevertheless, many users have requested support to
transfer more data at fast speeds into Spark.</p>

<p>Using <code class="highlighter-rouge">arrow</code> with <code class="highlighter-rouge">sparklyr</code>, we can transfer data directly from R to
Spark without having to serialize this data in R or persist in disk.</p>

<p>The following example copies 10M rows from R into Spark using <code class="highlighter-rouge">sparklyr</code>
with and without <code class="highlighter-rouge">arrow</code>, there is close to a 16x improvement using <code class="highlighter-rouge">arrow</code>.</p>

<p>This benchmark uses the <a href="https://CRAN.R-project.org/package=microbenchmark">microbenchmark</a> R package, which runs code
multiple times, provides stats on total execution time and plots each
excecution time to understand the distribution over each iteration.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">microbenchmark</span><span class="o">::</span><span class="n">microbenchmark</span><span class="p">(</span><span class="w">
  </span><span class="n">setup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">library</span><span class="p">(</span><span class="n">arrow</span><span class="p">),</span><span class="w">
  </span><span class="n">arrow_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">sparklyr_df</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="n">copy_to</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">
    </span><span class="n">count</span><span class="p">(</span><span class="n">sparklyr_df</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">collect</span><span class="p">()</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="n">arrow_off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s2">"arrow"</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">.packages</span><span class="p">())</span><span class="w"> </span><span class="n">detach</span><span class="p">(</span><span class="s2">"package:arrow"</span><span class="p">)</span><span class="w">
    </span><span class="n">sparklyr_df</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="n">copy_to</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">
    </span><span class="n">count</span><span class="p">(</span><span class="n">sparklyr_df</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">collect</span><span class="p">()</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="n">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="p">)</span><span class="w"> </span><span class="o">%T&gt;%</span><span class="w"> </span><span class="n">print</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">ggplot2</span><span class="o">::</span><span class="n">autoplot</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Unit: seconds
      expr       min        lq       mean    median         uq       max neval
  arrow_on  3.011515  4.250025   7.257739  7.273011   8.974331  14.23325    10
 arrow_off 50.051947 68.523081 119.946947 71.898908 138.743419 390.44028    10
</code></pre></div></div>

<div align="center">
<img src="/img/arrow-r-spark-copying.png" alt="Copying data with R into Spark with and without Arrow" width="60%" class="img-responsive" />
</div>

<h1 id="collecting">Collecting</h1>

<p>Similarly, <code class="highlighter-rouge">arrow</code> with <code class="highlighter-rouge">sparklyr</code> can now avoid deserializing data in R
while collecting data from Spark into R. These improvements are not as
significant as copying data since, <code class="highlighter-rouge">sparklyr</code> already collects data in
columnar format.</p>

<p>The following benchmark collects 10M rows from Spark into R and shows that
<code class="highlighter-rouge">arrow</code> can bring 3x improvements.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">microbenchmark</span><span class="o">::</span><span class="n">microbenchmark</span><span class="p">(</span><span class="w">
  </span><span class="n">setup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">library</span><span class="p">(</span><span class="n">arrow</span><span class="p">),</span><span class="w">
  </span><span class="n">arrow_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">collect</span><span class="p">(</span><span class="n">sparklyr_df</span><span class="p">)</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="n">arrow_off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s2">"arrow"</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">.packages</span><span class="p">())</span><span class="w"> </span><span class="n">detach</span><span class="p">(</span><span class="s2">"package:arrow"</span><span class="p">)</span><span class="w">
    </span><span class="n">collect</span><span class="p">(</span><span class="n">sparklyr_df</span><span class="p">)</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="n">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="p">)</span><span class="w"> </span><span class="o">%T&gt;%</span><span class="w"> </span><span class="n">print</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">ggplot2</span><span class="o">::</span><span class="n">autoplot</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Unit: seconds
      expr      min        lq      mean    median        uq       max neval
  arrow_on 4.520593  5.609812  6.154509  5.928099  6.217447  9.432221    10
 arrow_off 7.882841 13.358113 16.670708 16.127704 21.051382 24.373331    10
</code></pre></div></div>

<div align="center">
<img src="/img/arrow-r-spark-collecting.png" alt="Collecting data with R from Spark with and without Arrow" width="60%" class="img-responsive" />
</div>

<h1 id="transforming">Transforming</h1>

<p>Today, custom transformations of data using R functions are performed in
<code class="highlighter-rouge">sparklyr</code> by moving data in row-format from Spark into an R process through a
socket connection, transferring data in row-format is inefficient since
multiple data types need to be deserialized over each row, then the data gets
converted to columnar format (R was originally designed to use columnar data),
once R finishes this computation, data is again converted to row-format,
serialized row-by-row and then sent back to Spark over the socket connection.</p>

<p>By adding support for <code class="highlighter-rouge">arrow</code> in <code class="highlighter-rouge">sparklyr</code>, it makes Spark perform the
row-format to column-format conversion in parallel in Spark. Data
is then transferred through the socket but no custom serialization takes place.
All the R process needs to do is copy this data from the socket into its heap,
transform it and copy it back to the socket connection.</p>

<p>The following example transforms 100K rows with and without <code class="highlighter-rouge">arrow</code> enabled,
<code class="highlighter-rouge">arrow</code> makes transformation with R functions close to 41x faster.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">microbenchmark</span><span class="o">::</span><span class="n">microbenchmark</span><span class="p">(</span><span class="w">
  </span><span class="n">setup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">library</span><span class="p">(</span><span class="n">arrow</span><span class="p">),</span><span class="w">
  </span><span class="n">arrow_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">sample_n</span><span class="p">(</span><span class="n">sparklyr_df</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="o">^</span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">spark_apply</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">.x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">count</span><span class="p">()</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="n">arrow_off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s2">"arrow"</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">.packages</span><span class="p">())</span><span class="w"> </span><span class="n">detach</span><span class="p">(</span><span class="s2">"package:arrow"</span><span class="p">)</span><span class="w">
    </span><span class="n">sample_n</span><span class="p">(</span><span class="n">sparklyr_df</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="o">^</span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">spark_apply</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">.x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">count</span><span class="p">()</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="n">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="p">)</span><span class="w"> </span><span class="o">%T&gt;%</span><span class="w"> </span><span class="n">print</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">ggplot2</span><span class="o">::</span><span class="n">autoplot</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Unit: seconds
      expr        min         lq       mean     median         uq        max neval
  arrow_on   3.881293   4.038376   5.136604   4.772739   5.759082   7.873711    10
 arrow_off 178.605733 183.654887 213.296238 227.182018 233.601885 238.877341    10
</code></pre></div></div>

<div align="center">
<img src="/img/arrow-r-spark-transforming.png" alt="Transforming data with R in Spark with and without Arrow" width="60%" class="img-responsive" />
</div>

<p>Additional benchmarks and fine-tuning parameters can be found under <code class="highlighter-rouge">sparklyr</code>
<a href="https://github.com/rstudio/sparklyr/pull/1611">/rstudio/sparklyr/pull/1611</a> and <code class="highlighter-rouge">SparkR</code> <a href="https://github.com/apache/spark/pull/22954">/apache/spark/pull/22954</a>. Looking forward to bringing this feature
to the Spark, Arrow and R communities.</p>


    </main>

    <hr/>
<footer class="footer">
  <p>Apache Arrow, Arrow, Apache, the Apache feather logo, and the Apache Arrow project logo are either registered trademarks or trademarks of The Apache Software Foundation in the United States and other countries.</p>
  <p>&copy; 2016-2019 The Apache Software Foundation</p>
  <script integrity="sha256-jSo1n9J6iIJG62OLNqTotorGW58RxIufrGAfoMmn15Y=" crossorigin="anonymous" src="/assets/main-8d2a359fd27a888246eb638b36a4e8b68ac65b9f11c48b9fac601fa0c9a7d796.js" type="text/javascript"></script>
</footer>

  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <title>Apache Arrow Homepage</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Jekyll v3.8.4">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic,900">

    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/syntax.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-107500873-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-107500873-1');
</script>

    
  </head>


<body class="wrap">
  <header>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
  <a class="navbar-brand" href="/"><img src="/img/arrow-inverse-300px.png" height="60px"/></a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#arrow-navbar" aria-controls="arrow-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="arrow-navbar">
      <ul class="nav navbar-nav">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#"
             id="navbarDropdownProjectLinks" role="button" data-toggle="dropdown"
             aria-haspopup="true" aria-expanded="false">
             Project Links
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownProjectLinks">
            <a class="dropdown-item" href="/install/">Installation</a>
            <a class="dropdown-item" href="/release/">Releases</a>
            <a class="dropdown-item" href="/faq/">FAQ</a>
            <a class="dropdown-item" href="/blog/">Blog</a>
            <a class="dropdown-item" href="https://github.com/apache/arrow">Source Code</a>
            <a class="dropdown-item" href="https://issues.apache.org/jira/browse/ARROW">Issue Tracker</a>
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#"
             id="navbarDropdownCommunity" role="button" data-toggle="dropdown"
             aria-haspopup="true" aria-expanded="false">
             Community
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownCommunity">
            <a class="dropdown-item" href="http://mail-archives.apache.org/mod_mbox/arrow-user/">User Mailing List</a>
            <a class="dropdown-item" href="http://mail-archives.apache.org/mod_mbox/arrow-dev/">Dev Mailing List</a>
            <a class="dropdown-item" href="https://cwiki.apache.org/confluence/display/ARROW">Developer Wiki</a>
            <a class="dropdown-item" href="/committers/">Committers</a>
            <a class="dropdown-item" href="/powered_by/">Powered By</a>
          </div>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/docs/format/README.html"
             role="button" aria-haspopup="true" aria-expanded="false">
             Specification
          </a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#"
             id="navbarDropdownDocumentation" role="button" data-toggle="dropdown"
             aria-haspopup="true" aria-expanded="false">
             Documentation
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownDocumentation">
            <a class="dropdown-item" href="/docs">Project Docs</a>
            <a class="dropdown-item" href="/docs/python">Python</a>
            <a class="dropdown-item" href="/docs/cpp">C++</a>
            <a class="dropdown-item" href="/docs/java">Java</a>
            <a class="dropdown-item" href="/docs/c_glib">C GLib</a>
            <a class="dropdown-item" href="/docs/js">JavaScript</a>
            <a class="dropdown-item" href="/docs/r">R</a>
          </div>
        </li>
        <!-- <li><a href="/blog">Blog</a></li> -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#"
             id="navbarDropdownASF" role="button" data-toggle="dropdown"
             aria-haspopup="true" aria-expanded="false">
             ASF Links
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownASF">
            <a class="dropdown-item" href="http://www.apache.org/">ASF Website</a>
            <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a>
            <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Donate</a>
            <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a>
            <a class="dropdown-item" href="http://www.apache.org/security/">Security</a>
          </div>
        </li>
      </ul>
      <div class="flex-row justify-content-end ml-md-auto">
        <a class="d-sm-none d-md-inline pr-2" href="https://www.apache.org/events/current-event.html">
          <img src="https://www.apache.org/events/current-event-234x60.png"/>
        </a>
        <a href="http://www.apache.org/">
          <img src="/img/asf_logo.svg" width="120px"/>
        </a>
      </div>
      </div><!-- /.navbar-collapse -->
    </div>
  </nav>

  </header>

  <div class="container p-lg-4">
    <main role="main">
    
    
    
<h1>
  Improvements to Java Vector API in Apache Arrow 0.8.0
  <a href="/blog/2017/12/18/java-vector-improvements/" class="permalink" title="Permalink">∞</a>
</h1>



<p>
  <span class="badge badge-secondary">Published</span>
  <span class="published">
    18 Dec 2017
  </span>
  <br />
  <span class="badge badge-secondary">By</span>
  
    Siddharth Teotia
  
</p>


    <!--

-->

<p>This post gives insight into the major improvements in the Java implementation
of vectors. We undertook this work over the last 10 weeks since the last Arrow
release.</p>

<h2 id="design-goals">Design Goals</h2>

<ol>
  <li>Improved maintainability and extensibility</li>
  <li>Improved heap memory usage</li>
  <li>No performance overhead on hot code paths</li>
</ol>

<h2 id="background">Background</h2>

<h3 id="improved-maintainability-and-extensibility">Improved maintainability and extensibility</h3>

<p>We use templates in several places for compile time Java code generation for
different vector classes, readers, writers etc. Templates are helpful as the
developers don’t have to write a lot of duplicate code.</p>

<p>However, we realized that over a period of time some specific Java
templates became extremely complex with giant if-else blocks, poor code indentation
and documentation. All this impacted the ability to easily extend these templates
for adding new functionality or improving the existing infrastructure.</p>

<p>So we evaluated the usage of templates for compile time code generation and
decided not to use complex templates in some places by writing small amount of
duplicate code which is elegant, well documented and extensible.</p>

<h3 id="improved-heap-usage">Improved heap usage</h3>

<p>We did extensive memory analysis downstream in <a href="https://www.dremio.com/">Dremio</a> where Arrow is used
heavily for in-memory query execution on columnar data. The general conclusion
was that Arrow’s Java vector classes have non-negligible heap overhead and
volume of objects was too high. There were places in code where we were
creating objects unnecessarily and using structures that could be substituted
with better alternatives.</p>

<h3 id="no-performance-overhead-on-hot-code-paths">No performance overhead on hot code paths</h3>

<p>Java vectors used delegation and abstraction heavily throughout the object
hierarchy. The performance critical get/set methods of vectors went through a
chain of function calls back and forth between different objects before doing
meaningful work. We also evaluated the usage of branches in vector APIs and
reimplemented some of them by avoiding branches completely.</p>

<p>We took inspiration from how the Java memory code in <code class="highlighter-rouge">ArrowBuf</code> works. For all
the performance critical methods, <code class="highlighter-rouge">ArrowBuf</code> bypasses all the netty object
hierarchy, grabs the target virtual address and directly interacts with the
memory.</p>

<p>There were cases where branches could be avoided all together.</p>

<p>In case of nullable vectors, we were doing multiple checks to confirm if
the value at a given position in the vector is null or not.</p>

<h2 id="our-implementation-approach">Our implementation approach</h2>

<ul>
  <li>For scalars, the inheritance tree was simplified by writing different
abstract base classes for fixed and variable width scalars.</li>
  <li>The base classes contained all the common functionality across different
types.</li>
  <li>The individual subclasses implemented type specific APIs for fixed and
variable width scalar vectors.</li>
  <li>For the performance critical methods, all the work is done either in
the vector class or corresponding ArrowBuf. There is no delegation to any
internal object.</li>
  <li>The mutator and accessor based access to vector APIs is removed. These
objects led to unnecessary heap overhead and complicated the use of APIs.</li>
  <li>Both scalar and complex vectors directly interact with underlying buffers
that manage the offsets, data and validity. Earlier we were creating different
inner vectors for each vector and delegating all the functionality to inner
vectors. This introduced a lot of bugs in memory management, excessive heap
overhead and performance penalty due to chain of delegations.</li>
  <li>We reduced the number of vector classes by removing non-nullable vectors.
In the new implementation, all vectors in Java are nullable in nature.</li>
</ul>


    </main>

    <hr/>
<footer class="footer">
  <p>Apache Arrow, Arrow, Apache, the Apache feather logo, and the Apache Arrow project logo are either registered trademarks or trademarks of The Apache Software Foundation in the United States and other countries.</p>
  <p>&copy; 2016-2019 The Apache Software Foundation</p>
  <script integrity="sha256-jSo1n9J6iIJG62OLNqTotorGW58RxIufrGAfoMmn15Y=" crossorigin="anonymous" src="/assets/main-8d2a359fd27a888246eb638b36a4e8b68ac65b9f11c48b9fac601fa0c9a7d796.js" type="text/javascript"></script>
</footer>

  </div>
</body>
</html>

---
layout: post
title: "Apache Arrow nanoarrow 0.4.0 Release"
date: "2024-01-27 00:00:00"
author: pmc
categories: [release]
---
<!--
{% comment %}
Licensed to the Apache Software Foundation (ASF) under one or more
contributor license agreements.  See the NOTICE file distributed with
this work for additional information regarding copyright ownership.
The ASF licenses this file to you under the Apache License, Version 2.0
(the "License"); you may not use this file except in compliance with
the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
{% endcomment %}
-->

The Apache Arrow team is pleased to announce the 0.5.0 release of
Apache Arrow nanoarrow. This release covers 79 resolved issues from
9 contributors.

## Release Highlights

The primary focus of the nanoarrow 0.5.0 release was expanding the
initial [Python bindings](#python-bindings) that were released in 0.4.0.
The nanoarrow Python package can now create and consume most Arrow
data types, arrays, and array streams, including conversion to/from
objects compatible with the Python buffer protocol and conversion
to/from lists of Python objects.

The nanoarrow 0.5.0 release also includes updates to its build
configuration to make it possible to use nanoarrow with `FetchContent`
in projects with a wider variety of CMake usage. In addition to CMake,
nanoarrow now supports the Meson build system. Thanks to
[@vyasr](https://github.com/vyasr) and [@WillAyd](https://github.com/WillAyd)
for contributing these changes!

In the [R bindings](#python-bindings), support for reading IPC streams
is now accessible with `read_nanoarrow()`!

Finally, helpers to reconcile modern C++ usage with nanorrow C
structures (e.g., iterating over an `ArrowArrayStream` or
`ArrowArray` using a range-for loop) were added to `nanoarrow.hpp`.
Thanks to [@bkeitz](https://github.com/bkietz) for contributing these
changes!

See the
[Changelog](https://github.com/apache/arrow-nanoarrow/blob/apache-arrow-nanoarrow-0.5.0/CHANGELOG.md)
for a detailed list of contributions to this release.

## Breaking Changes

Most changes included in the nanoarrow 0.5.0 release will not break most downstream
code; however, several changes in the C library are breaking changes to previous
behaviour.

- `ArrowBufferResize()` and `ArrowBitmapResize()` now adjust `size_bytes`/
  `size_bits` in addition to `capacity_bytes`/`buffer.capacity_bytes`.
  Preivously these functions only adjusted the capacity of the underlying
  buffer which caused some understandable confusion even though this
  behaviour was documented. This change affects all usage of
  `ArrowBufferReisze()` and `ArrowBitmapResize()` that *increased* the size
  of the underlying buffer (i.e., usage where `shrink_to_fit` was non zero
  should be unaffected).
- `ArrowBufferReset()` now *always* calls the allocator's `free()` callback.
  Previously, a call to the `free()` callback was skipped if the pointer was
  `NULL`; however, this led to some confusion and made it easy to accidentally
  leak a custom deallocator whose pointer happened to be `NULL`.
- As a consequence of the above, it is now mandatory to call `ArrowBufferInit()`
  before calling `ArrowBufferReset()`. There was some existing usage of nanoarrow
  that zero-ed the memory for an `ArrowBuffer` and then (sometimes) called
  `ArrowBufferReset()`. Preivously this was a no-op; however, after 0.5.0 this
  will crash. This is consistent with other structures in the nanoarrow C library
  (which require an initialization before it is safe to reset/release them).


### Python bindings

The nanoarrow Python bindings are distributed as the `nanoarrow` package on
[PyPI](https://pypi.org/project/nanoarrow/) and [conda-forge](https://anaconda.org/conda-forge/nanoarrow):

```shell
pip install nanoarrow
conda install nanoarrow -c conda-forge
```

High level users can use the `Schema`, `Array`, and `ArrayStream` classes
to interact with

```python
import nanoarrow as na

na.int32()
#> <Schema> int32

na.Array([1, 2, 3], na.int32())
#> nanoarrow.Array<int32>[3]
#> 1
#> 2
#> 3

url = "https://github.com/apache/arrow-experiments/raw/main/data/arrow-commits/arrow-commits.arrows"
na.ArrayStream.from_url(url)
#> nanoarrow.ArrayStream<non-nullable struct<commit: string, time: timestamp('us', 'UTC'), files: int3...>
```

Low-level users can use `c_schema()`, `c_array()`, and `c_array_stream()` to interact
with thin wrappers around the Arrow C Data interface structures at a low level:

```python
na.c_schema(pa.decimal128(10, 3))
#> <nanoarrow.c_schema.CSchema decimal128(10, 3)>
#> - format: 'd:10,3'
#> - name: ''
#> - flags: 2
#> - metadata: NULL
#> - dictionary: NULL
#> - children[0]:

na.c_array(["one", "two", "three", None], na.string())
#> <nanoarrow.c_array.CArray string>
#> - length: 4
#> - offset: 0
#> - null_count: 1
#> - buffers: (4754305168, 4754307808, 4754310464)
#> - dictionary: NULL
#> - children[0]:
```

All nanoarrow type/array-like objects implement the
[Arrow PyCapsule interface](https://arrow.apache.org/docs/format/CDataInterface/PyCapsuleInterface.html)
for both producing and consuming and are zero-copy interchangeable with `pyarrow`
objects in many cases:

```python
import pyarrow as pa

pa.field(na.int32())
#> pyarrow.Field<: int32>

na.Schema(pa.string())
#> <Schema> string

pa.array(na.Array([4, 5, 6], na.int32()))
#> <pyarrow.lib.Int32Array object at 0x11b552500>
#> [
#>   4,
#>   5,
#>   6
#> ]

na.Array(pa.array([10, 11, 12]))
#> nanoarrow.Array<int64>[3]
#> 10
#> 11
#> 12
```

For a more detailed tour of the nanoarrow Python bindings, see the
[Getting started in Python guide](https://arrow.apache.org/nanoarrow/latest/getting-started/python.html) and the
[Python API reference](https://arrow.apache.org/nanoarrow/latest/reference/python.html).

### C/C++

The nanoarrow 0.5.0 release includes a number of bugfixes and improvements
to the core C library and C++ helpers.

Build system CMake

Build system Meson

C++ helper demo

### R bindings

The nanoarrow R bindings are distributed as the `nanoarrow` package on
[CRAN](https://cran.r-project.org/). The 0.5.0 release of the R bindings includes
two feature additions.


IPC reader

`nanoarrow_vctr()`


## Contributors

This release consists of contributions from 9 contributors in addition
to the invaluable advice and support of the Apache Arrow developer mailing list.

```console
$ git shortlog -sn apache-arrow-nanoarrow-0.5.0.dev..apache-arrow-nanoarrow-0.5.0 | grep -v "GitHub Actions"
TODO
```

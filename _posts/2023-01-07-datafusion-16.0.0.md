---
layout: post
title: "Apache Arrow DataFusion 16.0.0 Project Update"
date: "2023-01-07 00:00:00"
author: pmc
categories: [release]
---
<!--
{% comment %}
Licensed to the Apache Software Foundation (ASF) under one or more
contributor license agreements.  See the NOTICE file distributed with
this work for additional information regarding copyright ownership.
The ASF licenses this file to you under the Apache License, Version 2.0
(the "License"); you may not use this file except in compliance with
the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
{% endcomment %}
-->

# Introduction

[DataFusion](https://arrow.apache.org/datafusion/) is an extensible
query execution framework, written in [Rust](https://www.rust-lang.org/),
that uses [Apache Arrow](https://arrow.apache.org) as its
in-memory format. It is targeted primarily at developers creating data
intensive analytics, and offers mature
[SQL support](https://arrow.apache.org/datafusion/user-guide/sql/index.html),
a DataFrame API, and many extension points.

DataFusion based systems perform very well on performance
benchmarks, especially considering they operate on data in parquet
files directly rather than first loading into a specialized format.
Some recent highlights include [clickbench](https://benchmark.clickhouse.com/)
and the [Cloudfuse.io standalone query engines](https://www.cloudfuse.io/dashboards/standalone-engines) page.

DataFusion is part of a longer term trend, articulated clearly by [Andy Pavlo](http://www.cs.cmu.edu/~pavlo/) in his
[2022 Databases Retrospective](https://ottertune.com/blog/2022-databases-retrospective/).
Database frameworks are proliferating and it is likely that all OLAP DBMSs and other many data heavy applications such as machine learning, will require a vectorized, highly performant query
engine in the next 5 years to remain relevant.
The only practical way to make such technology so widely available
without many millions of dollars of investment is
though open source engine such as DataFusion or [Velox](https://github.com/facebookincubator/velox).

The rest of this post describes the improvements made to DataFusion
over the last three months and some hints of where we are heading.

## Community Growth

The three months since [our last update](https://arrow.apache.org/blog/2022/10/25/datafusion-13.0.0/) again saw significant growth in the DataFusion.

TODO quantify the growth -- e.g. XXX new contributors to the project and regularly merge YYY PRs a day.

According to [OSSRank](https://ossrank.com/p/1573-apache-arrow-datafusion) DataFusion's contributions are growing (TODO make coherent)

Growth of new systems based on as the engine in [many open source and commercial projects](https://github.com/apache/arrow-datafusion#known-uses) and was one of the early open source projects to provide this capability.

Several new databases built on DataFusion were announced:
* Greptimedb (new)
* Synnada data platform
* [PRQL](https://github.com/PRQL/prql-query) data transform language
* GA of InfluxDB IOx


The DataFusion 16.0.0 release consists of 520 PRs from 70 distinct contributors. This does not count all the work that goes into our dependencies such as [arrow](https://crates.io/crates/arrow),  [parquet](https://crates.io/crates/parquet), and [object_store](https://crates.io/crates/object_store), that much of the same community helps nurture.

<!--
$ git log --pretty=oneline 13.0.0..16.0.0 . | wc -l
TBD


$ git shortlog -sn 13.0.0..16.0.0 . | wc -l
TBD


At time of this writing:
$ git log --pretty=oneline 13.0.0..apache/master . | wc -l
     520

(arrow_dev) alamb@MacBook-Pro-8:~/Software/arrow-datafusion2$  git shortlog -sn 13.0.0..apache/master . | wc -l
      70
-->

## Performance ðŸš€

Performance and efficiency are core value propositions for
DataFusion. While there is still a performance gap between DataFusion best of
breed tightly, integrated systems such as [DuckDB](https://duckdb.org)
and [Polars](https://www.pola.rs/)https://www.pola.rs/), DataFusion is
closing the gap quickly. Performance highlights from the last three
months:

* XX% Faster Sorting and Merging using the new [Row Format](https://arrow.apache.org/blog/2022/11/07/multi-column-sorts-in-arrow-rust-part-1/)
* [Advanced predicate pushdown](https://arrow.apache.org/blog/2022/12/26/querying-parquet-with-millisecond-latency/), directly on parquet, optionally directly from object storage, enabling sub millisecond filtering, directly from object storage <!-- Andrew nots: we should really get this turned on by default -->
* Improved `IN` expressions significantly faster  Simplify InListExpr ~20-70% Faster ([#4057])
* Sort and partition aware optimizations such as  #3969 and  #4691,  skipping potentially expensive operations
* Basic filter selectivity analysis (#3868)


In the coming few months, we plan work on:
* Improved grouping performance (TODO link)
* bloom filtering
* investigate RLE (Run End Encoding support) (todo Arrow link)
* Enable predicate pushdown by default for all cases
* OTHERS?

## Runtime Resource Limits

Initially, DataFusion could potentially use unbounded amounts of memory for certain queries that included Sorts, Grouping or Joins.

In version 16.0.0, it is possible to limit DataFusion's memory usage for Sorting and Grouping. We are looking for help adding similar limiting for Joins as well as expanding our algorithms to spill to secondary storage, if available. See #3941 fore more detail.


## SQL Window Function
[SQL window functions](https://en.wikipedia.org/wiki/Window_function_(SQL))  are useful for a variety of analysis and DataFusion's implementation is close to complete now.

- Custom window frames such as `... OVER (ORDER BY ... RANGE BETWEEN 0.2 PRECEDING AND 0.2 FOLLOWING)`
- Unbounded window frames such as `... OVER (ORDER BY ... RANGE UNBOUNDED ROWS PRECEDING)`
- Support for the `NTILE` window function (#4676)
- Support for `GROUPS` mode (#4155)


# Improved Join Support

Joins are often the most complicated operations to handle well in
analytics systems and DataFusion 16.0.0 offers significant improvements
such as

- Cost based optimizer (CBO) that can automatically reorder join evaluations, algorithm (Merge / Hash), and pick build side based on available statistics join type (`INNER`, `LEFT`, etc) (#4219)
- Fast non `column=column` equijoins such as `JOIN ON a.x + 5 = b.y`
- Better optimized non-equijoins (nested loops rather than cross join and filter) (#4562) <!-- TODO is this a good thing to mention as any time this is usd the query is going to go slow or the data size is small -->

# Streaming Execution

One of the emerging use cases for Datafusion is to serve as the
foundation for high level streaming-first data platforms. An important
prerequisite for this goal is support for incremental execution if
queries that can be computed incrementally.

With this release, DataFusion now supports the following streaming features:

* Data ingestion from infinite files such as FIFOs (#4694),
* Detection of pipeline-breaking queries in streaming use cases (#4694),
* Rearranging join sides to support incremental execution when only one input side is a data stream (#4694),
* Intelligent elision of pipeline-breaking sort operations whenever possible (#4691),
* Incremental execution for more types of queries; e.g. queries involving finite window frames (#4777).

While this is a major step forward, we plan even more improvements over the next few releases.

# Better Support for Distributed catalogs

With the rise of distributed catalog / metadata stores such as
delta.io and iceberg (TODO get links to rust projects), it is
increasingly important to be enable asynchronous I/O to those remote
catalogs during query planning rather than requiring up front fast
local access to all relevant catalog information.


DataFusion has been enhanced with better support for such asynchronous catalogs (#4607) , which also resulted in improved configuration management APIs.



# Additional SQL support
SQL support continues to improve, including some of these highlights:

- Add TPC-DS query planning regression tests (#4719)
- feat: support prepare statement (#4490)
- Implement cast between Date and Timestamp (#4726)
- Support type coercion for timestamp and utf8 (#4312)
- Full support for time32 and time64 literal values (`ScalarValue`) (#4156)
- add uuid() function to return a unique uuid per row (#4041)
- Implement `current_time` scalar function (#4054)
- Implement current_date scalar function (#4022)
- Compressed CSV/JSON support (#3642)

The community has also been investing in sqllogic based tests to help keep DataFusion's quality high with less work (TODO add some more detail / lnks)


# Substrait

TODO motivating introduction of substrait and why this is interesting

We moved physical plan serde from Ballista to DataFusion (#4390) and we are in the proceess of adding support substrait


<!--
Andrew Lamb: I tried to work in a mention of the python bindings and encouraging a champion for them to step forward, however it felt more like it should be a separate post :thinking:
-->

## Looking for help:

DataFusion is currently targeted at developers building other systems, not at end users (e.g. data scientists) themselves. Given the currently growing number of systems built using DataFusion, it seems well suited for this purpose.

DataFusion has basic python bindings which has the potential to expand datafusion  to more end users a major missing piece are the python bindings


# python bindings and growing the community and ecosystem

If you are interested in helping us create the future please join the project. It is looking for testing, documentation and implementation help.

I would like to also talk about the Python bindings, even though they are released separately. The polars project uses its own custom implementation for many operators, we think a resuable framework like DataFusion offers the advantage of a larger commununity and thus more resources for additional advanced technology as we drive to make such technology available to all.

While DataFusion really shines as an embeddable query engine, if you want to try it out and get a feel for its power, you can use the basic[`datafusion-cli`](https://docs.rs/datafusion-cli/13.0.0/datafusion_cli/) tool to get a sense for what is possible to add in your application

-->

# How to Get Involved


Kudos to everyone in the community who contributed ideas, discussions, bug reports, documentation and code. It is exciting to be building something so cool together!

If you are interested in contributing to DataFusion, we would love to
have you join us. You can try out DataFusion on some of your own
data and projects and let us know how it goes or contribute a PR with
documentation, tests or code. A list of open issues suitable for
beginners is
[here](https://github.com/apache/arrow-datafusion/issues?q=is%3Aissue+is%3Aopen+label%3A%22good+first+issue%22).

Check out our [Communication Doc](https://arrow.apache.org/datafusion/community/communication.html) on more
ways to engage with the community.

## Appendix: Contributor Shoutout

Here is a list of people who have contributed PRs to this project over the last three releases, derived from `git shortlog -sn 13.0.0..16.0.0 .` Thank you all!

```
   110  Andrew Lamb
    56  jakevin
    45  Raphael Taylor-Davies
    28  Andy Grove
    19  Batuhan Taskaya
    19  Remzi Yang
    16  Burak
    16  ygf11
    15  Marco Neumann
    14  Kun Liu
    13  Jeffrey
    12  Yang Jiang
    10  mingmwang
     9  DaniÃ«l Heres
     9  comphead
     9  mvanschellebeeck
     9  xudong.w
     8  Mustafa akur
     7  yahoNanJing
     6  Brent Gardner
     6  dependabot[bot]
     5  AssHero
     4  Jiayu Liu
     4  Wei-Ting Kuo
     4  askoa
     3  AndrÃ© Calado Coroado
     3  Jie Han
     3  Metehan YÄ±ldÄ±rÄ±m
     3  Nga Tran
     3  Ruihang Xia
     3  baishen
     2  Berkay Åžahin
     2  Dan Harris
     2  Dongyan Zhou
     2  Kikkon
     2  Liang-Chi Hsieh
     2  Marko MilenkoviÄ‡
     2  Martin Grigorov
     2  Roman Nozdrin
     2  Tim Van Wassenhove
     2  r.4ntix
     2  unvalley
     1  Ajaya Agrawal
     1  Alexander Spies
     1  ArkashaJavelin
     1  Artjoms Iskovs
     1  BoredPerson
     1  Christian Salvati
     1  Creampanda
     1  Data Psycho
     1  Eduard Karacharov
     1  Francis Du
     1  Francis Le Roy
     1  LFC
     1  Marko Grujic
     1  Matthijs Brobbel
     1  Max Burke
     1  Rito Takeuchi
     1  Roman Zeyde
     1  Vrishabh
     1  Zhang Li
     1  ZuoTiJia
     1  byteink
     1  cfraz89
     1  nbr
     1  unconsolable
     1  xxchan
     1  yujie.zhang
     1  zembunia
     1  å“‡å‘œå“‡å‘œå‘€å’¦è€¶
....
```

[#4057]: https://github.com/apache/arrow-datafusion/issues/4057
